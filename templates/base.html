<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}My Learning App{% endblock %}</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='images/favicon.svg') }}">
    <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- HTMX for smooth transitions -->
    <script src="https://unpkg.com/htmx.org@1.9.10"
        integrity="sha384-D1Kt99CQMDuVetoL1lrYwg5t+9QdHe7NLX/SoJYkXDFfX37iInKRy5xLSi8nO7UC"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <style>
        .nav-item.active {
            color: var(--primary-color);
            position: relative;
        }

        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--primary-color);
            border-radius: 2px;
        }

        /* Smooth fade for content */
        .fade-content {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body hx-boost="true">

    <!-- Animated Gradient Mesh Background -->
    <div class="mesh-background" aria-hidden="true">
        <div class="mesh-blob mesh-blob-1"></div>
        <div class="mesh-blob mesh-blob-2"></div>
        <div class="mesh-blob mesh-blob-3"></div>
    </div>

    <!-- Page Loader -->
    <div class="loader-overlay" id="pageLoader">
        <div class="spinner"></div>
        <div class="loader-text">Loading...</div>
    </div>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="navbar-brand">
            Learn<span>App</span>
        </div>
        <div class="nav-links">
            {% if session.get('user') %}
            <a href="{{ url_for('dashboard') }}" class="nav-item">Dashboard</a>
            <a href="{{ url_for('gallery') }}" class="nav-item">Gallery</a>
            <a href="{{ url_for('users') }}" class="nav-item">Users</a>
            <a href="{{ url_for('students') }}" class="nav-item">Students</a>
            <a href="{{ url_for('logout') }}" class="nav-item" hx-boost="false"
                style="color: var(--secondary-color)">Logout</a>
            {% else %}
            <a href="{{ url_for('login') }}" class="nav-item">Login</a>
            {% endif %}

            <!-- Theme Toggle -->
            <div class="theme-toggle">
                <button id="themeBtn" class="nav-item theme-btn" title="Toggle Theme">
                    <span id="themeIcon">üåô</span>
                </button>
                <div class="theme-menu" id="themeMenu">
                    <div class="theme-option" data-value="midnight">üåå Midnight</div>
                    <div class="theme-option" data-value="dark">üåë Dark</div>
                    <div class="theme-option" data-value="light">‚òÄÔ∏è Light</div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container fade-content parallax-section" id="mainContent">
        {% block content %}{% endblock %}
    </div>

    {% block extra_body %}{% endblock %}

    <!-- Theme Script -->
    <script>
        (function () {
            const themeBtn = document.getElementById('themeBtn');
            const themeMenu = document.getElementById('themeMenu');
            const themeOptions = document.querySelectorAll('.theme-option');
            const themeIcon = document.getElementById('themeIcon');

            // Icons map
            const icons = {
                'midnight': 'üåå',
                'dark': 'üåë',
                'light': '‚òÄÔ∏è'
            };

            // Load saved theme
            const savedTheme = localStorage.getItem('theme') || 'midnight';
            document.documentElement.setAttribute('data-theme', savedTheme);
            if (themeIcon) themeIcon.textContent = icons[savedTheme];

            // Toggle menu
            if (themeBtn) {
                themeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    themeMenu.classList.toggle('active');
                });
            }

            // Close menu on outside click
            document.addEventListener('click', () => {
                if (themeMenu) themeMenu.classList.remove('active');
            });

            // Handle selection
            themeOptions.forEach(option => {
                option.addEventListener('click', () => {
                    const theme = option.getAttribute('data-value');
                    document.documentElement.setAttribute('data-theme', theme);
                    localStorage.setItem('theme', theme);
                    if (themeIcon) themeIcon.textContent = icons[theme];
                });
            });
        })();
    </script>

    <script>
        // Handle Active Link Highlighting
        document.addEventListener('DOMContentLoaded', () => {
            const currentPath = window.location.pathname;
            const navLinks = document.querySelectorAll('.nav-item');

            navLinks.forEach(link => {
                const linkPath = link.getAttribute('href');
                if (currentPath === linkPath || (currentPath.startsWith(linkPath) && linkPath !== '/')) {
                    link.classList.add('active');
                }
            });
        });

        // Handle Loader with HTMX events
        document.body.addEventListener('htmx:configRequest', function () {
            document.getElementById('pageLoader').classList.add('active');
        });

        document.body.addEventListener('htmx:afterOnLoad', function () {
            document.getElementById('pageLoader').classList.remove('active');

            // Re-run active link logic for new content
            const currentPath = window.location.pathname;
            const navLinks = document.querySelectorAll('.nav-item');
            navLinks.forEach(link => {
                link.classList.remove('active'); // Clear generic active
                if (link.getAttribute('href') === currentPath) {
                    link.classList.add('active');
                }
            });
        });

        // Fallback for standard loads (initial or non-HTMX)
        window.addEventListener('load', function () {
            document.getElementById('pageLoader').classList.remove('active');
        });

        // Show loader on standard beforeunload (for non-HTMX links or full reloads)
        window.addEventListener('beforeunload', function () {
            // Only show if not HTMX request (HTMX handles its own)
            if (!document.querySelector('.htmx-request')) {
                document.getElementById('pageLoader').classList.add('active');
            }
        });

        // --- Parallax Effect (Desktop Only) ---
        if (window.innerWidth > 768) {
            let lastScrollY = window.scrollY;
            const content = document.querySelector('.parallax-section');
            const blobs = document.querySelectorAll('.mesh-blob');

            // Throttled scroll listener
            let ticking = false;
            window.addEventListener('scroll', function () {
                if (!ticking) {
                    window.requestAnimationFrame(function () {
                        const ScrollY = window.scrollY;

                        // Move content slightly differently than scroll for depth
                        // Actually, standard parallax often moves background slower.
                        // Since background is fixed, let's move the blobs slightly to give life.

                        blobs.forEach((blob, index) => {
                            const speed = (index + 1) * 0.05;
                            const yPos = ScrollY * speed;
                            // blob.style.transform = `translateY(${yPos}px)`; 
                            // Note: This conflicts with the animation property 'transform'. 
                            // We should use 'top' or a nested transform if we want both.
                            // OR, just update margin-top which is cheaper than reprocessing keyframes? 
                            // No, margin causes layout. Transform is better.
                            // Let's use margin-top for scroll parallax on blobs to interact with their float animation transform
                            blob.style.marginTop = `${yPos}px`;
                        });

                        // Parallax on content?
                        // Maybe just the header elements or specific sections.
                        // For now, let's keep content standard scroll to avoid jitter, just animate bg.

                        ticking = false;
                    });
                    ticking = true;
                }
            });
        }
    </script>
</body>

</html>